From 8aa22bfc437b780edc103bab4f525ef35d54f4d7 Mon Sep 17 00:00:00 2001
From: Thomas Backman <serenity@exscape.org>
Date: Thu, 13 Dec 2012 12:23:26 +0100
Subject: [PATCH] First take at GCC patches for exscapeOS

---
 config.sub             |    2 +-
 gcc/config.gcc         |   11 +++++++++++
 gcc/config/exscapeos.h |    8 ++++++++
 libgcc/config.host     |    2 ++
 4 files changed, 22 insertions(+), 1 deletions(-)
 create mode 100644 gcc/config/exscapeos.h

diff --git a/config.sub b/config.sub
index 78176a4..1e8fa8f 100755
--- a/config.sub
+++ b/config.sub
@@ -1333,7 +1333,7 @@ case $os in
 	      | -hpux* | -unos* | -osf* | -luna* | -dgux* | -auroraux* | -solaris* \
 	      | -sym* | -kopensolaris* \
 	      | -amigaos* | -amigados* | -msdos* | -newsos* | -unicos* | -aof* \
-	      | -aos* | -aros* \
+	      | -aos* | -aros* | -exscapeos* \
 	      | -nindy* | -vxsim* | -vxworks* | -ebmon* | -hms* | -mvs* \
 	      | -clix* | -riscos* | -uniplus* | -iris* | -rtu* | -xenix* \
 	      | -hiux* | -386bsd* | -knetbsd* | -mirbsd* | -netbsd* \
diff --git a/gcc/config.gcc b/gcc/config.gcc
index 5fcd192..d8bc882 100644
--- a/gcc/config.gcc
+++ b/gcc/config.gcc
@@ -553,6 +553,12 @@ case ${target} in
     "" | yes | posix) thread_file='posix' ;;
   esac
   ;;
+*-*-exscapeos*)
+  extra_parts="crtbegin.o crtend.o"
+  gas=yes
+  gnu_ld=yes
+  default_use_cxa_atexit=yes
+  ;;
 *-*-freebsd*)
   # This is the generic ELF configuration of FreeBSD.  Later
   # machine-specific sections may refine and add to this
@@ -1197,6 +1203,11 @@ i[34567]86-*-darwin*)
 	with_cpu=${with_cpu:-core2}
 	tmake_file="${tmake_file} t-slibgcc"
 	;;
+i[34567]86-*-exscapeos*)
+	tm_file="${tm_file} i386/unix.h i386/att.h dbxelf.h elfos.h i386/i386elf.h exscapeos.h"
+	tmake_file="i386/t-i386elf t-svr4"
+	use_fixproto=yes
+	;;
 x86_64-*-darwin*)
 	with_cpu=${with_cpu:-core2}
 	tmake_file="${tmake_file} ${cpu_type}/t-darwin64 t-slibgcc"
diff --git a/gcc/config/exscapeos.h b/gcc/config/exscapeos.h
new file mode 100644
index 0000000..e63e35e
--- /dev/null
+++ b/gcc/config/exscapeos.h
@@ -0,0 +1,8 @@
+#undef TARGET_OS_CPP_BUILTINS
+#define TARGET_OS_CPP_BUILTINS()      \
+	do {                                \
+		builtin_define_std ("exscapeos");      \
+		builtin_define_std ("unix");      \
+		builtin_assert ("system=exscapeos");   \
+		builtin_assert ("system=unix");   \
+	} while(0);
diff --git a/libgcc/config.host b/libgcc/config.host
index ef9791b..a4b2806 100644
--- a/libgcc/config.host
+++ b/libgcc/config.host
@@ -1138,6 +1138,8 @@ mep*-*-*)
 	tmake_file="mep/t-mep t-fdpbit"
 	extra_parts="crtbegin.o crtend.o"
 	;;
+i[3-7]86-*-exscapeos*)
+	;;
 *)
 	echo "*** Configuration ${host} not supported" 1>&2
 	exit 1
-- 
1.7.7.4

